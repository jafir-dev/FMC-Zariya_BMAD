# Story 3: Ticket Creation System

## Status
Draft

## Story
**As a** Tenant,
**I want** to create detailed maintenance tickets with photos and track their progress,
**so that** I can easily report issues and stay informed about their resolution.

## Acceptance Criteria
1. After login, a user with the 'Customer' role is directed to their dashboard page.
2. The dashboard displays a list of one or more properties associated with that tenant's account.
3. A clear and prominent button or link labeled "Create New Request" is visible.
4. The "Create New Request" action opens the ticket submission form.
5. The form includes fields for: Problem Title, Description, and preferred Availability Times.
6. The form provides an option to upload at least one photo of the issue.
7. Upon submission, the form is validated to ensure required fields are filled.
8. A confirmation message ("Request Submitted Successfully") is shown to the tenant after submission.
9. The new ticket is saved to the database with a "New" status and linked to the correct tenant and property.
10. The tenant dashboard displays a list of all tickets submitted by that user.
11. Each ticket in the list shows its unique ID, Problem Title, Property, and current Status.
12. Clicking a ticket in the list navigates to a simple, read-only detail view of the submitted information.

## Tasks / Subtasks

- [ ] **Task 1: Create Customer Dashboard** (AC: 1, 2, 3)
  - [ ] Setup customer dashboard route and layout
  - [ ] Display property list for authenticated customer
  - [ ] Add prominent "Create New Request" call-to-action button
  - [ ] Implement customer-specific navigation and branding

- [ ] **Task 2: Build Ticket Data Model & API** (AC: 9)
  - [ ] Extend Prisma schema with Ticket model
  - [ ] Create ticket creation tRPC procedure
  - [ ] Add ticket listing procedure for customers
  - [ ] Implement ticket detail retrieval procedure

- [ ] **Task 3: Design Ticket Creation Form** (AC: 4, 5, 6, 7, 8)
  - [ ] Create multi-step ticket submission wizard
  - [ ] Build form fields: title, description, availability times
  - [ ] Implement photo upload functionality with Vercel Blob
  - [ ] Add form validation and error handling
  - [ ] Show success confirmation after submission

- [ ] **Task 4: Build Ticket List & Detail Views** (AC: 10, 11, 12)
  - [ ] Create customer ticket list component
  - [ ] Display ticket information with status indicators
  - [ ] Implement ticket detail modal/page
  - [ ] Add filtering and sorting capabilities

- [ ] **Task 5: File Upload Implementation** (AC: 6)
  - [ ] Configure Vercel Blob storage for photo uploads
  - [ ] Implement secure file upload with size/type validation
  - [ ] Add image preview and thumbnail generation
  - [ ] Handle upload errors and loading states

- [ ] **Task 6: Testing & Validation** (AC: 1-12)
  - [ ] Write unit tests for ticket API procedures
  - [ ] Test customer dashboard and navigation
  - [ ] Validate ticket creation workflow end-to-end
  - [ ] Test file upload functionality and limits

## Dev Notes

### Dependencies
**Requires completion of Story 2**
- User management system with customer accounts
- Authentication system with customer role access
- UI component library and dashboard layouts

### Data Models Required
`[Source: architecture/data-models.md#ticket-model]`

**Ticket Model**
```typescript
interface Ticket {
  id: string;
  title: string;
  description: string;
  status: TicketStatus;
  propertyId: string;
  customerId: string;
  assignedTechnicianId?: string;
  quoteAmount?: number;
  rating?: number;
  availabilityTimes?: string;
  photoUrls: string[];
  createdAt: Date;
  updatedAt: Date;
}
```

**TicketStatus Enum** `[Source: architecture/data-models.md#shared-enums-types]`
```typescript
export enum TicketStatus {
  NEW,
  ASSIGNED_FOR_INSPECTION,
  INSPECTION_COMPLETE,
  PENDING_CUSTOMER_APPROVAL,
  APPROVED_READY_FOR_WORK,
  WORK_IN_PROGRESS,
  PENDING_OTP_VERIFICATION,
  COMPLETED,
  CLOSED_REJECTED
}
```

### API Specifications
`[Source: architecture/api-specification.md#trpc-router-definitions]`

**Ticket Router Procedures**
```typescript
export const ticketRouter = createTRPCRouter({
  create: protectedProcedure(Role.CUSTOMER)
    .input(ticketCreateSchema)
    .mutation(async ({ ctx, input }) => { /* ... */ }),
    
  getMyTickets: protectedProcedure(Role.CUSTOMER)
    .query(async ({ ctx }) => { /* ... */ }),
    
  getById: protectedProcedure(Role.CUSTOMER)
    .input(z.object({ id: z.string() }))
    .query(async ({ ctx, input }) => { /* ... */ })
});
```

### File Storage Integration
`[Source: architecture/high-level-architecture.md#platform-and-infrastructure-choice]`
- **Vercel Blob**: Secure file storage for maintenance photos
- Signed URLs for secure file access
- File type validation (images only)
- Size limits and compression

### Component Architecture
**File Locations** `[Source: architecture/unified-project-structure.md]`
- Customer dashboard: `/src/app/(app)/dashboard/page.tsx`
- Ticket creation form: `/src/components/features/tickets/TicketForm.tsx`
- Ticket list: `/src/components/features/tickets/TicketList.tsx`
- File upload: `/src/components/ui/FileUpload.tsx`

### UI Requirements
`[Source: prd.md#core-screens-and-views]`
- **Customer Dashboard**: View properties, active/past tickets, create new requests
- **Ticket Submission Form**: Multi-step wizard for capturing details
- **Guided Workflows**: Step-by-step process with clear navigation
- **Real-time Feedback**: Immediate feedback for form actions

### Security Considerations
- File upload security with type/size validation
- Customer data isolation by FMC and user ID
- Input sanitization and validation
- Secure file storage with access controls

### Testing Standards
`[Source: architecture/testing-strategy.md]`
- Unit tests for ticket CRUD operations
- Integration tests for file upload workflow
- E2E tests for complete ticket creation process
- UI tests for customer dashboard functionality

## Change Log
| Date | Version | Description | Author |
| :--- | :--- |:--- |:--- |
| 2025-09-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after completion*