# Story 7: Job Execution & OTP Completion

## Status
Draft

## Story
**As a** Technician,
**I want** to execute approved jobs, upload evidence photos, and complete them with customer OTP verification,
**so that** I can provide verified, high-quality service with customer satisfaction tracking.

## Acceptance Criteria
1. The technician's "My Tasks" dashboard has a section or filter for tickets with the status "Approved - Ready for Work".
2. The technician can view the full ticket details, including the approved quote and the list of required materials.
3. A "Start Work" button is visible on the ticket detail view.
4. Clicking the "Start Work" button updates the ticket status to "Work in Progress".
5. The ticket detail view for the technician now includes fields to upload a "Before Work" photo and an "After Work" photo.
6. Photos are successfully uploaded and linked to the ticket.
7. A "Mark as Complete" button is available.
8. Clicking "Mark as Complete" updates the ticket status to "Pending OTP Verification".
9. The system generates a unique, 6-digit OTP that is valid for a short period (e.g., 10 minutes).
10. The OTP is sent to the tenant's registered email address.
11. The technician's view now shows a field to enter the OTP received from the customer.
12. The technician enters the OTP provided by the tenant into the app.
13. The system validates the OTP. Upon success, the ticket status is updated to "Completed".
14. If the OTP is incorrect or expired, an error message is shown.
15. After successful validation, the tenant's view of the ticket prompts them to provide a service rating (e.g., 1-5 stars).
16. The rating is saved and linked to the ticket.

## Tasks / Subtasks

- [ ] **Task 1: Extend Technician Dashboard for Job Execution** (AC: 1, 2, 3, 4)
  - [ ] Add "Ready for Work" section to technician dashboard
  - [ ] Display approved quotes and required materials
  - [ ] Implement "Start Work" functionality
  - [ ] Update ticket status to "Work in Progress"

- [ ] **Task 2: Build Job Evidence Upload System** (AC: 5, 6)
  - [ ] Create before/after photo upload components
  - [ ] Implement photo validation and compression
  - [ ] Store photos with proper categorization (before/after)
  - [ ] Add photo preview and management interface

- [ ] **Task 3: Implement OTP Generation & Delivery** (AC: 7, 8, 9, 10)
  - [ ] Create OTP generation service with expiration
  - [ ] Build "Mark as Complete" workflow
  - [ ] Design OTP email template for customers
  - [ ] Implement secure OTP delivery via email

- [ ] **Task 4: Build OTP Verification Interface** (AC: 11, 12, 13, 14)
  - [ ] Create OTP input component for technicians
  - [ ] Implement OTP validation logic
  - [ ] Handle expired and invalid OTP scenarios
  - [ ] Add error messaging and retry functionality

- [ ] **Task 5: Create Customer Rating System** (AC: 15, 16)
  - [ ] Build rating interface for completed jobs
  - [ ] Add 1-5 star rating component
  - [ ] Allow optional written feedback
  - [ ] Store ratings linked to tickets and technicians

- [ ] **Task 6: Complete Job Workflow Integration** (AC: 13, 16)
  - [ ] Integrate all completion steps in proper sequence
  - [ ] Handle workflow state transitions
  - [ ] Add completion notifications for all parties
  - [ ] Generate completion receipts/invoices

- [ ] **Task 7: Testing & Validation** (AC: 1-16)
  - [ ] Write unit tests for OTP generation and validation
  - [ ] Test complete job execution workflow
  - [ ] Validate photo upload and storage functionality
  - [ ] Test rating system and data persistence

## Dev Notes

### Dependencies
**Requires completion of Story 6**
- Quote approval workflow with "Approved - Ready for Work" status
- Customer approval system and notifications
- Inspection reports with approved quotes

### Data Model Extensions
**Job Completion Tracking**
```typescript
interface JobCompletion {
  id: string;
  ticketId: string;
  technicianId: string;
  startedAt: Date;
  completedAt?: Date;
  beforeWorkPhotoUrls: string[];
  afterWorkPhotoUrls: string[];
  otpCode: string;
  otpGeneratedAt: Date;
  otpExpiresAt: Date;
  otpVerifiedAt?: Date;
  customerRating?: number;
  customerFeedback?: string;
}

interface Ticket {
  // ... existing fields
  jobCompletion?: JobCompletion;
}
```

### API Specifications
**Job Execution Router Procedures**
```typescript
export const jobRouter = createTRPCRouter({
  startWork: protectedProcedure(Role.TECHNICIAN)
    .input(z.object({ ticketId: z.string() }))
    .mutation(async ({ ctx, input }) => { /* Update status to Work in Progress */ }),
    
  uploadWorkPhotos: protectedProcedure(Role.TECHNICIAN)
    .input(z.object({ 
      ticketId: z.string(),
      photoType: z.enum(['BEFORE', 'AFTER']),
      photoData: z.string()
    }))
    .mutation(async ({ ctx, input }) => { /* ... */ }),
    
  markComplete: protectedProcedure(Role.TECHNICIAN)
    .input(z.object({ ticketId: z.string() }))
    .mutation(async ({ ctx, input }) => { 
      // Generate OTP, send email, update status
    }),
    
  verifyOTP: protectedProcedure(Role.TECHNICIAN)
    .input(z.object({ ticketId: z.string(), otpCode: z.string() }))
    .mutation(async ({ ctx, input }) => { /* ... */ }),
    
  rateService: protectedProcedure(Role.CUSTOMER)
    .input(z.object({ 
      ticketId: z.string(),
      rating: z.number().min(1).max(5),
      feedback: z.string().optional()
    }))
    .mutation(async ({ ctx, input }) => { /* ... */ })
});
```

### OTP System Implementation
**OTP Generation Logic**
```typescript
interface OTPConfig {
  length: 6;
  expiryMinutes: 10;
  allowedRetries: 3;
  rateLimit: 5; // per hour
}

const generateOTP = (): string => {
  return Math.random().toString().substring(2, 8);
};

const validateOTP = (provided: string, stored: string, expiresAt: Date): boolean => {
  return provided === stored && new Date() < expiresAt;
};
```

### Component Architecture
**File Locations**
- Job dashboard: `/src/app/(app)/technician/jobs/page.tsx`
- Work execution: `/src/components/features/technician/JobExecution.tsx`
- Photo upload: `/src/components/features/jobs/PhotoUpload.tsx`
- OTP verification: `/src/components/features/jobs/OTPVerification.tsx`
- Rating system: `/src/components/features/customer/ServiceRating.tsx`

### UI Components Required
- Job status timeline component
- Before/after photo comparison view
- OTP input with countdown timer
- Star rating component with feedback
- Progress indicators for job stages
- Photo gallery with categorization

### Business Logic Requirements
**Job Execution Workflow**
1. Technician starts approved job
2. System tracks start time and updates status
3. Technician uploads before-work photos
4. Work is performed (offline activity)
5. Technician uploads after-work photos
6. Technician marks job as complete
7. System generates and emails OTP to customer
8. Customer provides OTP to technician on-site
9. Technician enters OTP in system
10. System validates OTP and marks job complete
11. Customer rates service quality
12. Completion notifications sent to all parties

**Photo Requirements**
- Minimum 1 before photo, 1 after photo
- Maximum 5 photos per category
- Image compression and optimization
- Timestamp and location metadata (optional)
- Secure storage with access controls

### Email Integration
**OTP Delivery Email Template**
```html
Subject: Verification Code - Job Completion #{{ticketId}}

Dear {{customerName}},

Your maintenance work has been completed! To verify the job completion, please provide this code to the technician:

Verification Code: {{otpCode}}

This code expires in 10 minutes.

Property: {{propertyName}}
Technician: {{technicianName}}
Completed: {{completionTime}}

Thank you for using {{fmcName}}!
```

### Security Considerations
- OTP codes are single-use and time-limited
- Photos include metadata for verification
- Customer ratings cannot be modified after submission
- Job completion audit trail maintained
- Secure photo storage with access logging

### Performance Considerations
- Photo upload with progress indicators
- Efficient OTP generation and storage
- Mobile-optimized interfaces for field use
- Offline capability for photo capture
- Fast OTP validation response times

### Integration Requirements
**Receipt/Invoice Generation** `[Source: prd.md#functional-requirements]`
- Downloadable receipts for completed paid work
- FMC branding on all documents
- Itemized cost breakdown
- Work completion evidence (photos)
- Customer signature and rating

### Testing Standards
- Unit tests for OTP generation and validation logic
- Integration tests for complete job workflow
- Photo upload and storage functionality tests
- Email delivery and OTP verification tests
- Customer rating system validation
- Security tests for OTP handling

## Change Log
| Date | Version | Description | Author |
| :--- | :--- |:--- |:--- |
| 2025-09-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after completion*