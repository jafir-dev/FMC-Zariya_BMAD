# Story 6: Quote Approval Workflow

## Status
Draft

## Story
**As a** Tenant,
**I want** to receive and be able to approve or reject a quote for paid maintenance work,
**so that** I have control over the costs and can make informed decisions about repairs.

## Acceptance Criteria
1. The supervisor's dashboard shows tickets with the status "Inspection Complete".
2. The supervisor can view the technician's full report, including the quote and materials list.
3. If the job is "Paid", a "Send Quote to Customer" button is visible.
4. Clicking the button updates the ticket's status to "Pending Customer Approval".
5. A basic email notification is sent to the tenant containing the quote details.
6. The tenant's dashboard shows tickets with the status "Pending Customer Approval".
7. The ticket detail view clearly displays the quote amount and work details from the technician's report.
8. Two prominent buttons, "Approve Quote" and "Reject Quote," are visible.
9. Clicking "Approve Quote" updates the ticket's status to "Approved - Ready for Work".
10. Clicking "Reject Quote" updates the ticket's status to "Closed - Rejected by Customer".
11. The supervisor receives an email notification of the tenant's decision in both cases.

## Tasks / Subtasks

- [ ] **Task 1: Extend Supervisor Quote Review Interface** (AC: 1, 2, 3, 4)
  - [ ] Add inspection report display to supervisor dashboard
  - [ ] Show quote amount, materials list, and cost breakdown
  - [ ] Implement "Send Quote to Customer" button for paid jobs
  - [ ] Update ticket status when quote is sent to customer

- [ ] **Task 2: Build Quote Notification System** (AC: 5, 11)
  - [ ] Create email template for quote approval requests
  - [ ] Implement quote details formatting in email
  - [ ] Add supervisor notification for customer decisions
  - [ ] Include quote summary and decision deadline in emails

- [ ] **Task 3: Create Customer Quote Review Interface** (AC: 6, 7, 8)
  - [ ] Add "Pending Approval" section to customer dashboard
  - [ ] Design quote detail view with cost breakdown
  - [ ] Display technician's inspection report and materials
  - [ ] Add prominent approve/reject action buttons

- [ ] **Task 4: Implement Quote Approval API** (AC: 9, 10)
  - [ ] Create tRPC procedures for quote approval/rejection
  - [ ] Update ticket status based on customer decision
  - [ ] Add approval/rejection timestamp tracking
  - [ ] Implement customer decision audit trail

- [ ] **Task 5: Build Quote Decision Workflow** (AC: 9, 10, 11)
  - [ ] Create confirmation dialogs for approval/rejection
  - [ ] Add reason field for quote rejection
  - [ ] Implement approval success flow
  - [ ] Handle notification delivery and tracking

- [ ] **Task 6: Testing & Validation** (AC: 1-11)
  - [ ] Write unit tests for quote approval API procedures
  - [ ] Test supervisor quote review and sending workflow
  - [ ] Validate customer approval/rejection process
  - [ ] Test email notification delivery and content

## Dev Notes

### Dependencies
**Requires completion of Story 5**
- Technician inspection reporting system
- Tickets with "Inspection Complete" status
- Inspection reports with quotes and materials

### Data Model Extensions
**Quote Approval Tracking**
```typescript
interface QuoteApproval {
  id: string;
  ticketId: string;
  inspectionReportId: string;
  sentToCustomerAt: Date;
  sentById: string; // Supervisor ID
  customerDecision?: 'APPROVED' | 'REJECTED';
  decisionAt?: Date;
  rejectionReason?: string;
  approvalNotes?: string;
}

interface Ticket {
  // ... existing fields
  quoteApproval?: QuoteApproval;
}
```

### API Specifications
**Quote Approval Router Procedures**
```typescript
export const quoteRouter = createTRPCRouter({
  sendToCustomer: protectedProcedure(Role.SUPERVISOR)
    .input(z.object({ ticketId: z.string() }))
    .mutation(async ({ ctx, input }) => { 
      // Update status, send email, create approval record
    }),
    
  getPendingApprovals: protectedProcedure(Role.CUSTOMER)
    .query(async ({ ctx }) => { /* Get customer's pending quotes */ }),
    
  approveQuote: protectedProcedure(Role.CUSTOMER)
    .input(z.object({ 
      ticketId: z.string(),
      notes: z.string().optional()
    }))
    .mutation(async ({ ctx, input }) => { /* ... */ }),
    
  rejectQuote: protectedProcedure(Role.CUSTOMER)
    .input(z.object({ 
      ticketId: z.string(),
      reason: z.string()
    }))
    .mutation(async ({ ctx, input }) => { /* ... */ })
});
```

### Email Templates
**Quote Approval Request Email**
```html
Subject: Quote Approval Required - Ticket #{{ticketId}}

Dear {{customerName}},

Your maintenance request has been inspected and we have prepared a quote for the required work.

Property: {{propertyName}}
Issue: {{ticketTitle}}
Quote Amount: {{quoteAmount}} AED
Estimated Materials: {{materialsList}}

Please review and approve/reject this quote by logging into your dashboard:
[Review Quote Button]

The quote is valid for 7 days.

Best regards,
{{fmcName}}
```

### Component Architecture
**File Locations**
- Quote review (supervisor): `/src/components/features/supervisor/QuoteReview.tsx`
- Quote approval (customer): `/src/components/features/customer/QuoteApproval.tsx`
- Email templates: `/src/lib/email-templates/`
- Quote API: `/src/server/api/routers/quote.ts`

### UI Components Required
- Quote summary card with cost breakdown
- Material list display component
- Approval/rejection confirmation modals
- Email composition and preview
- Decision history timeline

### Business Logic Requirements
**Quote Approval Workflow**
1. Supervisor reviews inspection report
2. Sends quote to customer via email
3. Customer receives notification with quote details
4. Customer reviews quote and makes decision
5. System updates ticket status based on decision
6. Supervisor receives notification of decision
7. If approved, ticket moves to "Ready for Work"
8. If rejected, ticket is closed with reason

**Validation Rules**
- Only paid inspection reports can be sent for approval
- Quote must include amount and materials list
- Customer has limited time to make decision (configurable)
- Rejection requires reason from predefined list

### Email Integration
**Quote Email Features**
- Professional quote formatting
- Embedded company branding (white-label)
- Direct links to approval interface
- Quote expiration date
- Contact information for questions

**Notification Requirements**
- Immediate email delivery for quote requests
- Supervisor notification on customer decision
- Reminder emails for pending quotes (future enhancement)

### Security Considerations
- Customer can only approve/reject their own quotes
- Quote amounts cannot be modified after sending
- Decision audit trail for dispute resolution
- Secure email links with token authentication

### Performance Considerations
- Email delivery tracking and retry logic
- Quote approval interface mobile optimization
- Fast loading for quote detail views
- Efficient notification queuing system

### Testing Standards
- Unit tests for quote approval logic
- Integration tests for email notification system
- E2E tests for complete approval workflow
- UI tests for customer decision interface

## Change Log
| Date | Version | Description | Author |
| :--- | :--- |:--- |:--- |
| 2025-09-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after completion*