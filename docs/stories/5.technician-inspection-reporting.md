# Story 5: Technician Inspection & Reporting

## Status
Draft

## Story
**As a** Technician,
**I want** to see my assigned inspection tasks and submit detailed reports with cost estimates,
**so that** I can efficiently complete inspections and provide accurate quotes for required work.

## Acceptance Criteria
1. After login, a 'Technician' role is directed to a "My Tasks" dashboard.
2. The dashboard lists all tickets assigned to them with the status "Assigned for Inspection".
3. The technician can click a task to view the full ticket details submitted by the tenant.
4. The ticket view includes a button to "Submit Inspection Report".
5. The "Submit Inspection Report" button opens a new form.
6. The form allows the technician to select if the work is "Free of Charge" or "Paid".
7. If "Paid" is selected, fields for a Quote amount and a list of Required Materials are displayed.
8. Upon submission, the ticket status is updated to "Inspection Complete".
9. The inspection report, including any quote, is saved and linked to the ticket.
10. The technician can upload photos during the inspection process.

## Tasks / Subtasks

- [ ] **Task 1: Create Technician Dashboard** (AC: 1, 2)
  - [ ] Setup technician dashboard route with role-based access
  - [ ] Display assigned tickets with "Assigned for Inspection" status
  - [ ] Add task priority indicators and property information
  - [ ] Create technician-specific navigation and layout

- [ ] **Task 2: Build Inspection Reporting Data Model** (AC: 8, 9)
  - [ ] Extend Prisma schema with InspectionReport model
  - [ ] Create relationship between tickets and inspection reports
  - [ ] Add cost type enum (Free/Paid) and material list structure
  - [ ] Implement quote and materials data validation

- [ ] **Task 3: Design Ticket Detail View for Technicians** (AC: 3, 4)
  - [ ] Create technician-specific ticket detail component
  - [ ] Display customer-submitted information and photos
  - [ ] Show property details and customer availability
  - [ ] Add "Submit Inspection Report" call-to-action

- [ ] **Task 4: Build Inspection Report Form** (AC: 5, 6, 7)
  - [ ] Create multi-step inspection report wizard
  - [ ] Add cost type selection (Free/Paid radio buttons)
  - [ ] Implement conditional quote amount and materials fields
  - [ ] Add form validation and error handling

- [ ] **Task 5: Implement Inspection Photo Upload** (AC: 10)
  - [ ] Add photo upload capability to inspection reports
  - [ ] Allow multiple inspection photos with descriptions
  - [ ] Integrate with Vercel Blob storage
  - [ ] Add image compression and optimization

- [ ] **Task 6: Create Inspection API Procedures** (AC: 8, 9)
  - [ ] Build tRPC procedure for inspection report submission
  - [ ] Implement ticket status update to "Inspection Complete"
  - [ ] Add procedure for retrieving technician's assigned tasks
  - [ ] Create validation schemas for inspection data

- [ ] **Task 7: Testing & Validation** (AC: 1-10)
  - [ ] Write unit tests for inspection report API
  - [ ] Test technician dashboard and task management
  - [ ] Validate inspection form workflow
  - [ ] Test photo upload and storage functionality

## Dev Notes

### Dependencies
**Requires completion of Story 4**
- Supervisor ticket assignment system
- Tickets with "Assigned for Inspection" status
- Technician user accounts and role-based access

### Data Model Extensions
**Inspection Report Model**
```typescript
interface InspectionReport {
  id: string;
  ticketId: string;
  technicianId: string;
  costType: 'FREE' | 'PAID';
  quoteAmount?: number;
  currency: string;
  requiredMaterials: Material[];
  notes?: string;
  inspectionPhotoUrls: string[];
  createdAt: Date;
  updatedAt: Date;
}

interface Material {
  id: string;
  name: string;
  quantity: number;
  estimatedCost?: number;
  supplier?: string;
}
```

### API Specifications
**Technician Router Procedures**
```typescript
export const technicianRouter = createTRPCRouter({
  getMyTasks: protectedProcedure(Role.TECHNICIAN)
    .query(async ({ ctx }) => { /* Get assigned tickets */ }),
    
  getTaskDetails: protectedProcedure(Role.TECHNICIAN)
    .input(z.object({ ticketId: z.string() }))
    .query(async ({ ctx, input }) => { /* ... */ }),
    
  submitInspectionReport: protectedProcedure(Role.TECHNICIAN)
    .input(inspectionReportSchema)
    .mutation(async ({ ctx, input }) => { 
      // Create report, update ticket status, notify supervisor
    }),
    
  uploadInspectionPhoto: protectedProcedure(Role.TECHNICIAN)
    .input(z.object({ reportId: z.string(), photoData: z.string() }))
    .mutation(async ({ ctx, input }) => { /* ... */ })
});
```

### Component Architecture
**File Locations**
- Technician dashboard: `/src/app/(app)/technician/page.tsx`
- Task detail view: `/src/components/features/technician/TaskDetail.tsx`
- Inspection form: `/src/components/features/technician/InspectionForm.tsx`
- Material list component: `/src/components/features/technician/MaterialList.tsx`

### UI Components Required
- Task list with status indicators
- Multi-step inspection report form
- Dynamic material entry component
- Photo upload with preview
- Cost type radio button selection
- Quote calculation component

### Business Logic Requirements
**Inspection Workflow**
1. Technician views assigned tasks
2. Selects task and reviews customer details
3. Conducts on-site inspection
4. Determines if work is free or paid
5. If paid, provides quote and materials list
6. Uploads inspection photos (optional)
7. Submits report
8. System updates ticket status
9. Supervisor receives notification

**Validation Rules**
- Quote amount required if cost type is "Paid"
- Materials list optional but recommended for paid work
- Photo uploads have size and format restrictions
- Currency defaults to AED for UAE market

### Integration Requirements
**File Storage** `[Source: architecture/high-level-architecture.md]`
- Vercel Blob for inspection photo storage
- Image optimization and thumbnail generation
- Secure signed URLs for photo access

**Notification System**
- Email notification to supervisor when report submitted
- In-app notification for report completion
- SMS notification capability for urgent issues

### Security Considerations
- Technician access limited to their assigned tickets
- Photo upload security and validation
- Quote amount and materials data integrity
- Inspection report audit trail

### Testing Standards
- Unit tests for inspection report CRUD operations
- Integration tests for photo upload workflow
- E2E tests for complete inspection process
- Performance tests for large photo uploads

## Change Log
| Date | Version | Description | Author |
| :--- | :--- |:--- |:--- |
| 2025-09-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after completion*