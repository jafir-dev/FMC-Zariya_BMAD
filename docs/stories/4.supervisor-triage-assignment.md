# Story 4: Supervisor Triage & Assignment

## Status
Draft

## Story
**As a** Supervisor,
**I want** to see a dashboard of all new tickets for the buildings I manage,
**so that** I can review them and assign them to a technician for inspection.

## Acceptance Criteria
1. A user with the 'Supervisor' role is directed to their dashboard upon login.
2. The dashboard displays a list of all tickets with the status "New" from their assigned properties.
3. The supervisor can click a ticket to view its full details, including any photos.
4. The detail view includes a dropdown list of available technicians.
5. The supervisor can select a technician and click an "Assign for Inspection" button.
6. Upon assignment, the ticket's status is updated to "Assigned for Inspection".
7. A basic email notification is sent to the assigned technician.
8. The supervisor can view all tickets across different status categories.
9. Assignment history and notes can be tracked for each ticket.

## Tasks / Subtasks

- [ ] **Task 1: Create Supervisor Dashboard** (AC: 1, 2)
  - [ ] Setup supervisor dashboard route with role-based access
  - [ ] Create dashboard layout showing ticket queue organized by status
  - [ ] Implement property-based ticket filtering for supervisor's buildings
  - [ ] Add ticket statistics and summary cards

- [ ] **Task 2: Build Ticket Assignment API** (AC: 5, 6, 9)
  - [ ] Create tRPC procedure for ticket assignment
  - [ ] Implement ticket status update logic
  - [ ] Add assignment history tracking
  - [ ] Create procedure to fetch available technicians by property/FMC

- [ ] **Task 3: Design Ticket Detail & Assignment Interface** (AC: 3, 4, 5)
  - [ ] Create ticket detail modal with full information display
  - [ ] Add photo gallery component for viewing uploaded images
  - [ ] Build technician selection dropdown with availability indicators
  - [ ] Implement assignment confirmation flow

- [ ] **Task 4: Implement Notification System** (AC: 7)
  - [ ] Setup email notification service (Resend integration)
  - [ ] Create email templates for technician assignment notifications
  - [ ] Add notification preferences and delivery tracking
  - [ ] Handle notification failures gracefully

- [ ] **Task 5: Build Ticket Management Views** (AC: 8)
  - [ ] Create tabbed interface for different ticket statuses
  - [ ] Add filtering and search capabilities
  - [ ] Implement bulk assignment operations
  - [ ] Add supervisor-specific ticket analytics

- [ ] **Task 6: Testing & Validation** (AC: 1-9)
  - [ ] Write unit tests for assignment API procedures
  - [ ] Test supervisor dashboard functionality
  - [ ] Validate email notification delivery
  - [ ] Test role-based access and data isolation

## Dev Notes

### Dependencies
**Requires completion of Story 3**
- Ticket creation system with NEW status tickets
- Customer dashboard and ticket submission workflow
- File upload functionality for viewing ticket photos

### Data Model Extensions
**Assignment History Tracking**
```typescript
interface TicketAssignment {
  id: string;
  ticketId: string;
  assignedById: string; // Supervisor ID
  assignedToId: string; // Technician ID
  assignedAt: Date;
  notes?: string;
}

interface Ticket {
  // ... existing fields
  assignments: TicketAssignment[];
  currentAssigneeId?: string;
}
```

### API Specifications
**Supervisor Router Procedures**
```typescript
export const supervisorRouter = createTRPCRouter({
  getNewTickets: protectedProcedure(Role.SUPERVISOR)
    .query(async ({ ctx }) => { /* Get NEW tickets for supervisor's properties */ }),
    
  getTicketsByStatus: protectedProcedure(Role.SUPERVISOR)
    .input(z.object({ status: z.nativeEnum(TicketStatus) }))
    .query(async ({ ctx, input }) => { /* ... */ }),
    
  assignTicket: protectedProcedure(Role.SUPERVISOR)
    .input(z.object({ 
      ticketId: z.string(), 
      technicianId: z.string(),
      notes: z.string().optional()
    }))
    .mutation(async ({ ctx, input }) => { /* ... */ }),
    
  getAvailableTechnicians: protectedProcedure(Role.SUPERVISOR)
    .input(z.object({ propertyId: z.string() }))
    .query(async ({ ctx, input }) => { /* ... */ })
});
```

### Email Notification Integration
`[Source: architecture/external-apis.md#resend-api]`
- **Resend API** for transactional emails
- Email templates for assignment notifications
- Delivery tracking and failure handling
- Unsubscribe and preference management

### Component Architecture
**File Locations**
- Supervisor dashboard: `/src/app/(app)/supervisor/page.tsx`
- Ticket assignment modal: `/src/components/features/supervisor/TicketAssignment.tsx`
- Notification service: `/src/lib/notifications.ts`
- Assignment API: `/src/server/api/routers/supervisor.ts`

### UI Components Required
- Tabbed interface for ticket status categories
- Modal dialogs for ticket details and assignment
- Dropdown selection for technician assignment
- Photo gallery component for viewing images
- Status badges and progress indicators

### Business Logic Requirements
**Property-Based Access Control**
- Supervisors only see tickets from their assigned properties
- FMC-level data isolation
- Role-based procedure protection

**Assignment Workflow**
1. Supervisor views NEW tickets
2. Reviews ticket details and photos
3. Selects appropriate technician
4. Adds optional assignment notes
5. Confirms assignment
6. System updates ticket status
7. Email notification sent to technician

### Security Considerations
- Supervisor access limited to their assigned properties
- Technician list filtered by property and FMC association
- Assignment history audit trail
- Email notification security

### Testing Standards
- Unit tests for assignment logic and procedures
- Integration tests for notification system
- UI tests for supervisor dashboard workflow
- Security tests for data access control

## Change Log
| Date | Version | Description | Author |
| :--- | :--- |:--- |:--- |
| 2025-09-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after completion*