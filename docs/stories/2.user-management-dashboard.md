# Story 2: User Management Dashboard

## Status
Draft

## Story
**As an** FMC Head,
**I want** a dashboard to create, view, and manage all users (staff and tenants) for my properties,
**so that** I can onboard my entire team and client base onto the platform.

## Acceptance Criteria
1. A protected page/view is accessible only to users with the 'FMC Head' role.
2. The page displays a list of all users associated with the FMC Head's company.
3. A form allows the creation of new users, including assigning them a role and property.
4. The FMC Head can activate or deactivate user accounts.
5. Users can be edited to update their role, property assignments, and contact information.
6. The interface provides filtering and search capabilities for managing large user lists.

## Tasks / Subtasks

- [ ] **Task 1: Create FMC Head Dashboard Layout** (AC: 1)
  - [ ] Setup protected route with FMC Head role verification
  - [ ] Create dashboard layout with navigation and user management sections
  - [ ] Implement role-based route guard middleware
  - [ ] Add breadcrumb navigation for user management area

- [ ] **Task 2: Build User Management API Endpoints** (AC: 2, 3, 4, 5)
  - [ ] Create tRPC router for user management operations
  - [ ] Implement user creation procedure with role and property assignment
  - [ ] Add user listing procedure filtered by FMC company
  - [ ] Create user update and activation/deactivation procedures
  - [ ] Add input validation with Zod schemas

- [ ] **Task 3: Design User List Interface** (AC: 2, 6)
  - [ ] Create user table component with sorting capabilities
  - [ ] Implement search and filter functionality by role and status
  - [ ] Add pagination for large user lists
  - [ ] Display user status indicators (active/inactive)

- [ ] **Task 4: Build User Creation Form** (AC: 3)
  - [ ] Create multi-step user creation wizard
  - [ ] Add form fields for email, name, role selection, property assignment
  - [ ] Implement form validation and error handling
  - [ ] Add success/failure feedback messages

- [ ] **Task 5: Implement User Edit & Management** (AC: 4, 5)
  - [ ] Create user edit modal/page
  - [ ] Add toggle for user activation/deactivation
  - [ ] Implement bulk user operations
  - [ ] Add confirmation dialogs for destructive actions

- [ ] **Task 6: Testing & Validation** (AC: 1-6)
  - [ ] Write unit tests for user management API procedures
  - [ ] Test role-based access control for FMC Head dashboard
  - [ ] Validate user creation and editing flows
  - [ ] Test search, filter, and pagination functionality

## Dev Notes

### Dependencies
**Requires completion of Stories 1-1, 1-2, 1-3**
- Database schemas and User model (Story 1-1)
- Authentication system and role-based access (Story 1-2)
- UI components and dashboard layouts (Story 1-3)

### Data Models Required
`[Source: architecture/data-models.md]`

**User Model Extension**
```typescript
interface User {
  id: string;
  email: string;
  name: string;
  role: Role;
  fmcId: string;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
  propertyIds: string[]; // Many-to-many relationship
}
```

**FMC Model**
```typescript
interface FMC {
  id: string;
  name: string;
  contactEmail: string;
  logoUrl?: string;
  users: User[];
  properties: Property[];
}
```

### API Specifications
`[Source: architecture/backend-architecture.md#service-architecture]`

**tRPC User Router Procedures**
```typescript
export const userRouter = createTRPCRouter({
  create: protectedProcedure(Role.FMC_HEAD)
    .input(userCreateSchema)
    .mutation(async ({ ctx, input }) => { /* ... */ }),
    
  list: protectedProcedure(Role.FMC_HEAD)
    .input(userFilterSchema)
    .query(async ({ ctx, input }) => { /* ... */ }),
    
  update: protectedProcedure(Role.FMC_HEAD)
    .input(userUpdateSchema)
    .mutation(async ({ ctx, input }) => { /* ... */ }),
    
  toggleStatus: protectedProcedure(Role.FMC_HEAD)
    .input(z.object({ userId: z.string(), isActive: z.boolean() }))
    .mutation(async ({ ctx, input }) => { /* ... */ })
});
```

### Component Architecture
`[Source: architecture/frontend-architecture.md#component-organization]`

**File Locations**
- Dashboard page: `/src/app/(app)/admin/users/page.tsx`
- User list component: `/src/components/features/users/UserList.tsx`
- User form component: `/src/components/features/users/UserForm.tsx`
- User management API: `/src/server/api/routers/user.ts`

### UI Components Needed
- DataTable with sorting and filtering
- Modal dialogs for user creation/editing
- Form components with validation
- Status badges and action buttons
- Search and filter controls

### Security Requirements
`[Source: architecture/security-and-performance.md#security]`
- Role-based access control for FMC Head only
- Input validation with Zod schemas
- Audit logging for user management actions
- Data segregation by FMC company

### Testing Standards
`[Source: architecture/testing-strategy.md]`
- Unit tests for tRPC user management procedures
- Integration tests for user creation workflow
- UI tests for dashboard functionality
- Security tests for role-based access control

## Change Log
| Date | Version | Description | Author |
| :--- | :--- |:--- |:--- |
| 2025-09-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after completion*