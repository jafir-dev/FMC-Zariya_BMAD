# Story 1.2: Authentication System

## Status
Draft

## Story
**As a** User,
**I want** to log in securely with my email and password,
**so that** I can access the application and my role-specific dashboard.

## Acceptance Criteria
1. A secure login API endpoint is created.
2. User credentials are validated against hashed passwords in the `User` table.
3. On successful login, a secure JWT is returned to the client.
4. A basic, functional login page is created on the PWA.
5. The PWA stores the session token securely and provides a method for logout.
6. Role-based access control middleware is implemented for protecting routes.
7. Users are redirected to appropriate dashboards based on their role after login.

## Tasks / Subtasks

- [ ] **Task 1: Configure Next-Auth.js** (AC: 1, 2, 3)
  - [ ] Setup Next-Auth configuration with credentials provider
  - [ ] Configure JWT strategy for session management
  - [ ] Implement password hashing verification with bcrypt
  - [ ] Setup database adapter for user authentication

- [ ] **Task 2: Create Authentication API Routes** (AC: 1, 3)
  - [ ] Configure Next-Auth API routes (`/api/auth/*`)
  - [ ] Implement credential validation logic
  - [ ] Setup JWT token generation and validation
  - [ ] Add error handling for invalid credentials

- [ ] **Task 3: Build Login Page** (AC: 4, 5)
  - [ ] Create login form component with email/password fields
  - [ ] Implement form validation and error display
  - [ ] Add loading states during authentication
  - [ ] Setup secure token storage and logout functionality

- [ ] **Task 4: Implement Role-Based Access Control** (AC: 6, 7)
  - [ ] Create middleware for protecting routes based on user roles
  - [ ] Setup role-based redirect logic after successful login
  - [ ] Create session context for accessing user data across components
  - [ ] Implement route guards for different user types

- [ ] **Task 5: Testing & Validation** (AC: 1-7)
  - [ ] Write unit tests for authentication functions
  - [ ] Test login/logout flows for all user roles
  - [ ] Verify secure token handling and session management
  - [ ] Test role-based route protection

## Dev Notes

### Authentication Architecture
`[Source: architecture/backend-architecture.md#authorization]`
- Next-Auth.js ~5.0.0-beta.19 for authentication
- JWT strategy with httpOnly cookies for security
- Password hashing with bcrypt
- Role-based procedure middleware in tRPC

### Security Requirements
`[Source: architecture/security-and-performance.md#security]`
- HttpOnly cookies for session storage
- Zod input validation for all auth forms
- Content Security Policy (CSP) enforcement
- Secure password hashing with salt rounds

### File Locations
`[Source: architecture/unified-project-structure.md]`
- Auth configuration: `/src/server/auth.ts`
- Auth API routes: `/src/app/api/auth/[...nextauth]/route.ts`
- Login page: `/src/app/(auth)/login/page.tsx`
- Auth middleware: `/src/middleware.ts`
- Session context: `/src/lib/auth.tsx`

### User Data Model
`[Source: architecture/data-models.md#user-model]`
```typescript
interface User {
  id: string;
  email: string;
  name: string;
  role: Role;
  fmcId: string;
  isActive: boolean;
  createdAt: Date;
}
```

### Role-Based Routing
`[Source: architecture/frontend-architecture.md#routing-architecture]`
- Protected routes under `/(app)` directory
- Authentication routes under `/(auth)` directory
- Layout-level authentication checks
- Role-based dashboard redirects

### Testing Standards
`[Source: architecture/testing-strategy.md]`
- Unit tests with Vitest for auth functions
- Integration tests for login/logout flows
- Mock Next-Auth for testing environments
- Test all 7 user role authentication scenarios

## Change Log
| Date | Version | Description | Author |
| :--- | :--- |:--- |:--- |
| 2025-09-07 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA agent after completion*